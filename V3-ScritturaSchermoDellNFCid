esphome:
  name: schermo-badge
  friendly_name: schermo-badge

substitutions:
  devicename: "Schermo Badge"

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

psram:
  mode: octal
  speed: 80MHz

logger:

api:
  encryption:
    key: "hAqA6CZAjS67s5XZXKWn7qHS1mEfHM2RlGvLfGQhPH0="

ota:
  - platform: esphome
    password: "21d7d144cff2296ebcee8606b1e820d9"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Schermo-Badge Fallback Hotspot"
    password: "UHfOJ7p0Hc2z"

captive_portal:

i2c:
  sda: 44
  scl: 43
  scan: true
  id: bus_a

# Variabile per il timer
globals:
  - id: tag_message_active
    type: bool
    initial_value: 'false'

pn532_i2c:
  i2c_id: bus_a
  on_tag:
    then:
      - homeassistant.tag_scanned: !lambda 'return x;'
      - lambda: |-
          // Accendi il display
          id(back_light).turn_on();
          
          // Costruisci il messaggio usando l'ID del tag (variabile 'x')
          std::string message = "Tag Rilevato:\n" + x;
          
          // Aggiorna il testo nel display
          lv_label_set_text(id(tag_message), message.c_str());
          lv_obj_clear_flag(id(tag_message), LV_OBJ_FLAG_HIDDEN);
          
          // Nascondi il messaggio Hello World
          lv_obj_add_flag(id(hello_label), LV_OBJ_FLAG_HIDDEN);
          
          // Avvia il timer per tornare alla schermata normale
          id(tag_message_active) = true;
          id(reset_display).execute();

output:
  - platform: ledc
    pin: 2
    frequency: 1220 Hz
    id: gpio_backlight_pwm

light:
  - platform: monochromatic
    output: gpio_backlight_pwm
    name: ${devicename} Display Backlight
    id: back_light
    restore_mode: ALWAYS_ON

spi:
  clk_pin: GPIO12
  mosi_pin: GPIO11
  miso_pin: GPIO13

touchscreen:
  - platform: xpt2046
    id: my_touchscreen
    cs_pin: GPIO38
    interrupt_pin: GPIO18
    update_interval: 50ms
    threshold: 800
    calibration:
      x_min: 200
      x_max: 3800
      y_min: 350
      y_max: 3580

display:
  - platform: rpi_dpi_rgb
    update_interval: never
    id: my_display
    color_order: RGB
    rotation: 0
    dimensions:
      width: 800
      height: 480
    de_pin:
      number: 40
    hsync_pin: 39
    vsync_pin: 41
    pclk_pin: 42
    data_pins:
      red:
        - 45
        - 48
        - 47
        - 21
        - 14
      green:
        - 5
        - 6
        - 7
        - 15
        - 16
        - 4
      blue:
        - 8
        - 3
        - 46
        - 9
        - 1

# LVGL con visualizzazione tag
lvgl:
  displays:
    - my_display
  pages:
    - id: main_page
      widgets:
        - label:
            id: hello_label
            align: CENTER
            text: 'Hello World!'
            text_font: my_font
        - label:
            id: tag_message
            align: CENTER
            text: ''
            text_font: tag_font
            text_color: 0xFF0000
            hidden: true

font:
  - file: "gfonts://Roboto"
    id: my_font
    size: 40
  - file: "gfonts://Roboto"
    id: tag_font
    size: 30

# Script per resettare il display dopo 5 secondi
script:
  - id: reset_display
    then:
      - delay: 5s
      - lambda: |-
          if (id(tag_message_active)) {
            // Nascondi il messaggio del tag
            lv_obj_add_flag(id(tag_message), LV_OBJ_FLAG_HIDDEN);
            // Mostra di nuovo Hello World
            lv_obj_clear_flag(id(hello_label), LV_OBJ_FLAG_HIDDEN);
            id(tag_message_active) = false;
          }

button:
  - platform: template
    name: "Attiva Display"
    on_press:
      then:
        - light.turn_on: back_light
